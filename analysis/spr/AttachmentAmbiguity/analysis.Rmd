---
title: "demo_attachment"
author: "Mari Kugemoto"
date: "5/20/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## set up
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(tidyr)
library(lme4)
library(lmerTest)
library(stringr)
library(brms)
library(tidybayes)

# set the directory
setwd('~/Documents/GitHub/sapbenchmark/')

# load the shared functions
source("/Users/mkugemoto/Documents/GitHub/sapbenchmark/analysis/shared/util.R")
```

## brms models
prior1 <- c(prior("normal(300,1000)", class = "Intercept"),
            prior("normal(0,150)", class = "b"),  
            prior("normal(0,200)", class = "sd"),  #brms automatically truncates the dist.  
            prior("normal(0,500)", class = "sigma"))
### ROI=0
brm_prior1_0 <- brm(RT ~ ambiguity + height + (1+ambiguity+height||item) + (1+height+ambiguity||participant),
                    data=subset(rt.data, rt.data$ROI==0),
                    cores = 4,
                    prior = prior1,
                    iter = 6000,
                    control = list(adapt_delta = 0.9),
                    seed = 117)
save(brm_prior1_0, file="brm_prior1_0.RData")

### ROI=1
brm_prior1_1 <- brm(RT ~ ambiguity + height + (1+ambiguity+height||item) + (1+height+ambiguity||participant),
                    data=subset(rt.data, rt.data$ROI==1),
                    cores = 4,
                    prior = prior1,
                    iter = 6000,
                    control = list(adapt_delta = 0.9),
                    seed = 117)
save(brm_prior1_1, file="brm_prior1_1.RData")

### ROI=2
brm_prior1_2 <- brm(RT ~ ambiguity + height + (1+ambiguity+height||item) + (1+height+ambiguity||participant),
                    data=subset(rt.data, rt.data$ROI==2),
                    cores = 4,
                    prior = prior1,
                    iter = 6000,
                    control = list(adapt_delta = 0.9),
                    seed = 117)
save(brm_prior1_2, file="brm_prior1_2.RData")

# brms
## load the data
```{r}
rt.data <- load_data("AttachmentAmbiguity")


# function to read and name .RData
loadRData <- function(fileName){
  #loads an RData file, and returns it
  load(fileName)
  get(ls()[ls() != "fileName"])
}

brm_prior1_0 <- loadRData("brm_prior1_0.RData")
brm_prior1_1 <- loadRData("brm_prior1_1.RData")
brm_prior1_2 <- loadRData("brm_prior1_2.RData")

summary(brm_prior1_0)
summary(brm_prior1_1)
summary(brm_prior1_2)
```

## predict RTs
```{r}
setwd('~/Documents/GitHub/sapbenchmark/')
# lstm
attach_pred_lstm <- Predicting_RT_with_spillover(rt.data, "AttachmentAmbiguity", "lstm")

# gpt2
attach_pred_gpt2 <- Predicting_RT_with_spillover(rt.data, "AttachmentAmbiguity", "gpt2")
```

## extract posterior estimates (no need to run this again)
```{r}
# extract posterior estimates
#reshaped_item_dat_attach_0 <- reshape_item_dat(brm_prior1_0, "item")
#reshaped_item_dat_attach_1 <- reshape_item_dat(brm_prior1_1, "item")
#reshaped_item_dat_attach_2 <- reshape_item_dat(brm_prior1_2, "item")

# save them
#saveRDS(reshaped_item_dat_attach_0, "reshaped_item_dat_attach_0.rds")
#saveRDS(reshaped_item_dat_attach_1, "reshaped_item_dat_attach_1.rds")
#saveRDS(reshaped_item_dat_attach_2, "reshaped_item_dat_attach_2.rds")
```

```{r}
# load the data (reshaped_item_dat)
reshape_item_output_P0 <- readRDS("reshaped_item_dat_attach_0.rds") 
reshape_item_output_P0$ROI <- 0
reshape_item_output_P1 <- readRDS("reshaped_item_dat_attach_1.rds") 
reshape_item_output_P1$ROI <- 1
reshape_item_output_P2 <- readRDS("reshaped_item_dat_attach_2.rds")
reshape_item_output_P2$ROI <- 2
reshape_item_output <- rbind(reshape_item_output_P0,reshape_item_output_P1,reshape_item_output_P2)
reshape_item_output$item <- as.numeric(reshape_item_output$item)

# by item
by_item <- reshape_item_output %>%
  mutate(GPE_low = -b_ambiguity + (-1/2)*b_height -r_ambiguity + (-1/2)*r_height,
         GPE_high = -b_ambiguity + (1/2)*b_height -r_ambiguity + (1/2)*r_height
         ) %>%
  select(`.chain`, `.draw`, `.iteration`, item, ROI, GPE_low, GPE_high) %>% 
  gather(key = 'coef', value ='val', GPE_low, GPE_high) %>%
  group_by(item, ROI , coef) %>%
  summarise(mean = mean(val),
            lower = quantile(val, 0.025)[[1]], 
            upper = quantile(val, 0.975)[[1]])
#write.csv(by_item, "by_item.csv")

# by construction
by_construction <- reshape_item_output[,c('.draw', 'ROI', colnames(reshape_item_output)[str_detect(colnames(reshape_item_output),'b')])] %>% 
  unique() %>%
  mutate(GPE_low = -b_ambiguity + (-1/2)*b_height,
         GPE_high = -b_ambiguity + (1/2)*b_height) %>%
  select(`.draw`, ROI, GPE_low,GPE_high) %>% 
  gather(key='coef',value='val', GPE_low, GPE_high)%>%
  group_by(ROI, coef)%>%
  summarise(mean=mean(val),
            lower=quantile(val,0.025)[[1]],
            upper=quantile(val,0.975)[[1]])
by_construction$ROI <- as.character(by_construction$ROI)
#write.csv(by_construction, "by_construction.csv")
```

## plot
```{r}
Plot_empirical_construction_level(by_construction,"AttachmentAmbiguity")

Plot_itemwise_by_magnitude(by_item,"AttachmentAmbiguity",ROI=0)
Plot_itemwise_by_magnitude(by_item,"AttachmentAmbiguity",ROI=1)
Plot_itemwise_by_magnitude(by_item,"AttachmentAmbiguity",ROI=2)
```

### surprisals
```{r}
merged_surp <- merge_surprisal(rt.data, by_item, "AttachmentAmbiguity")
```



### brms models (predicted)

# load the data
```{r}
attach_pred_lstm <- read.csv("attach_pred_lstm.csv", head=TRUE) %>% 
  filter(predicted <= 7000) %>% 
  filter(predicted>0) %>% 
  mutate(participant=MD5)
attach_pred_lstm$AMBIG <- ifelse(
  attach_pred_lstm$Type=="AttachMulti", "Amb", "Unamb"
)
attach_pred_lstm$Sentence <- str_replace_all(attach_pred_lstm$Sentence, "%2C", ",")

# contrasts
attach_pred_lstm$ambiguity <- ifelse(
  attach_pred_lstm$AMBIG=="Amb",2/3,-1/3)

attach_pred_lstm <- attach_pred_lstm %>% 
  mutate(height = case_when(Type=="AttachMulti" ~ 0, 
                            Type=="AttachLow" ~ -1/2,
                            Type=="AttachHigh" ~ 1/2))

# gpt2
attach_pred_gpt2 <- read.csv("attach_pred_gpt2.csv", head=TRUE) %>% 
  filter(predicted <= 7000) %>% 
  filter(predicted>0) %>% 
  mutate(participant=MD5)
attach_pred_gpt2$AMBIG <- ifelse(
  attach_pred_gpt2$Type=="AttachMulti", "Amb", "Unamb"
)
attach_pred_gpt2$Sentence <- str_replace_all(attach_pred_gpt2$Sentence, "%2C", ",")

# contrasts
attach_pred_gpt2$ambiguity <- ifelse(
  attach_pred_gpt2$AMBIG=="Amb",2/3,-1/3)

attach_pred_gpt2 <- attach_pred_gpt2 %>% 
  mutate(height = case_when(Type=="AttachMulti" ~ 0, 
                            Type=="AttachLow" ~ -1/2,
                            Type=="AttachHigh" ~ 1/2))
```

```{r}
## brms models
prior1 <- c(prior("normal(300,1000)", class = "Intercept"),
            prior("normal(0,150)", class = "b"),  
            prior("normal(0,200)", class = "sd"),  #brms automatically truncates the dist.  
            prior("normal(0,500)", class = "sigma"))

### ROI=0, lstm
brm_prior1_pred_lstm_0 <- brm(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                    data=subset(attach_pred_lstm, attach_pred_lstm$ROI==0),
                    cores = 4,
                    prior = prior1,
                    iter = 12000,
                    control = list(adapt_delta = 0.8),
                    seed = 117,
                    warmup=6000)
save(brm_prior1_pred_lstm_0, file="brm_prior1_pred_lstm_0.RData")

### ROI=1, lstm
brm_prior1_pred_lstm_1 <- brm(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                    data=subset(attach_pred_lstm, attach_pred_lstm$ROI==1),
                    cores = 4,
                    prior = prior1,
                    iter = 12000,
                    control = list(adapt_delta = 0.8),
                    seed = 117,
                    warmup=6000)
save(brm_prior1_pred_lstm_1, file="brm_prior1_pred_lstm_1.RData")

### ROI=2, lstm
brm_prior1_pred_lstm_2 <- brm(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                    data=subset(attach_pred_lstm, attach_pred_lstm$ROI==2),
                    cores = 4,
                    prior = prior1,
                    iter = 12000,
                    control = list(adapt_delta = 0.8),
                    seed = 117,
                    warmup=6000)
save(brm_prior1_pred_lstm_2, file="brm_prior1_pred_lstm_2.RData")

### ROI=0, gpt2
brm_prior1_pred_gpt2_0 <- brm(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                    data=subset(attach_pred_gpt2, attach_pred_gpt2$ROI==0),
                    cores = 4,
                    prior = prior1,
                    iter = 12000,
                    control = list(adapt_delta = 0.8),
                    seed = 117,
                    warmup=6000)
save(brm_prior1_pred_gpt2_0, file="brm_prior1_pred_gpt2_0.RData")

### ROI=1, gpt2
brm_prior1_pred_gpt2_1 <- brm(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                    data=subset(attach_pred_gpt2, attach_pred_gpt2$ROI==1),
                    cores = 4,
                    prior = prior1,
                    iter = 12000,
                    control = list(adapt_delta = 0.8),
                    seed = 117,
                    warmup=6000)
save(brm_prior1_pred_gpt2_1, file="brm_prior1_pred_gpt2_1.RData")

### ROI=2, gpt2
brm_prior1_pred_gpt2_2 <- brm(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                    data=subset(attach_pred_gpt2, attach_pred_gpt2$ROI==2),
                    cores = 4,
                    prior = prior1,
                    iter = 12000,
                    control = list(adapt_delta = 0.8),
                    seed = 117,
                    warmup=6000)
save(brm_prior1_pred_gpt2_2, file="brm_prior1_pred_gpt2_2.RData")
```

## extract posterior estimates (no need to run this again)
```{r}
## lstm
# extract posterior estimates
reshaped_item_dat_attach_pred_lstm_0 <- reshape_item_dat(brm_prior1_pred_lstm_0, "item")
reshaped_item_dat_attach_pred_lstm_1 <- reshape_item_dat(brm_prior1_pred_lstm_1, "item")
reshaped_item_dat_attach_pred_lstm_2 <- reshape_item_dat(brm_prior1_pred_lstm_2, "item")

# save them
saveRDS(reshaped_item_dat_attach_pred_lstm_0, "reshaped_item_dat_attach_pred_lstm_0.rds")
saveRDS(reshaped_item_dat_attach_pred_lstm_1, "reshaped_item_dat_attach_pred_lstm_1.rds")
saveRDS(reshaped_item_dat_attach_pred_lstm_2, "reshaped_item_dat_attach_pred_lstm_2.rds")

## gpt2
# extract posterior estimates
reshaped_item_dat_attach_pred_gpt2_0 <- reshape_item_dat(brm_prior1_pred_gpt2_0, "item")
reshaped_item_dat_attach_pred_gpt2_1 <- reshape_item_dat(brm_prior1_pred_gpt2_1, "item")
reshaped_item_dat_attach_pred_gpt2_2 <- reshape_item_dat(brm_prior1_pred_gpt2_2, "item")

# save them
saveRDS(reshaped_item_dat_attach_pred_gpt2_0, "reshaped_item_dat_attach_pred_gpt2_0.rds")
saveRDS(reshaped_item_dat_attach_pred_gpt2_1, "reshaped_item_dat_attach_pred_gpt2_1.rds")
saveRDS(reshaped_item_dat_attach_pred_gpt2_2, "reshaped_item_dat_attach_pred_gpt2_2.rds")
```

```{r}
# load the data (reshaped_item_dat)
reshape_item_output_P0 <- readRDS("reshaped_item_dat_attach_pred_lstm_0.rds") 
reshape_item_output_P0$ROI <- 0
reshape_item_output_P1 <- readRDS("reshaped_item_dat_attach_pred_lstm_1.rds") 
reshape_item_output_P1$ROI <- 1
reshape_item_output_P2 <- readRDS("reshaped_item_dat_attach_pred_lstm_2.rds")
reshape_item_output_P2$ROI <- 2
reshape_item_output_lstm <- rbind(reshape_item_output_P0,reshape_item_output_P1,reshape_item_output_P2)
reshape_item_output_lstm$item <- as.numeric(reshape_item_output_lstm$item)

# by item
by_item_lstm <- reshape_item_output_lstm %>%
  mutate(GPE_low = -b_ambiguity + (-1/2)*b_height -r_ambiguity + (-1/2)*r_height,
         GPE_high = -b_ambiguity + (1/2)*b_height -r_ambiguity + (1/2)*r_height
         ) %>%
  select(`.chain`, `.draw`, `.iteration`, item, ROI, GPE_low, GPE_high) %>% 
  gather(key = 'coef', value ='val', GPE_low, GPE_high) %>%
  group_by(item, ROI , coef) %>%
  summarise(mean = mean(val),
            lower = quantile(val, 0.025)[[1]], 
            upper = quantile(val, 0.975)[[1]])
saveRDS(by_item_lstm, "by_item_lstm.rds")

# by construction
by_construction_lstm <- reshape_item_output_lstm[,c('.draw', 'ROI', colnames(reshape_item_output_lstm)[str_detect(colnames(reshape_item_output_lstm),'b')])] %>% 
  unique() %>%
  mutate(GPE_low = -b_ambiguity + (-1/2)*b_height,
         GPE_high = -b_ambiguity + (1/2)*b_height) %>%
  select(`.draw`, ROI, GPE_low,GPE_high) %>% 
  gather(key='coef',value='val', GPE_low, GPE_high)%>%
  group_by(ROI, coef)%>%
  summarise(mean=mean(val),
            lower=quantile(val,0.025)[[1]],
            upper=quantile(val,0.975)[[1]])
by_construction_lstm$ROI <- as.character(by_construction_lstm$ROI)
write.csv(by_construction_lstm, "by_construction_lstm.csv")
saveRDS(by_construction_lstm, "by_construction_lstm.rds")


## gpt2 ##
# load the data (reshaped_item_dat)
reshape_item_output_P0 <- readRDS("reshaped_item_dat_attach_pred_gpt2_0.rds") 
reshape_item_output_P0$ROI <- 0
reshape_item_output_P1 <- readRDS("reshaped_item_dat_attach_pred_gpt2_1.rds") 
reshape_item_output_P1$ROI <- 1
reshape_item_output_P2 <- readRDS("reshaped_item_dat_attach_pred_gpt2_2.rds")
reshape_item_output_P2$ROI <- 2
reshape_item_output_gpt2 <- rbind(reshape_item_output_P0,reshape_item_output_P1,reshape_item_output_P2)
reshape_item_output_gpt2$item <- as.numeric(reshape_item_output_gpt2$item)

# by item
by_item_gpt2 <- reshape_item_output_gpt2 %>%
  mutate(GPE_low = -b_ambiguity + (-1/2)*b_height -r_ambiguity + (-1/2)*r_height,
         GPE_high = -b_ambiguity + (1/2)*b_height -r_ambiguity + (1/2)*r_height
         ) %>%
  select(`.chain`, `.draw`, `.iteration`, item, ROI, GPE_low, GPE_high) %>% 
  gather(key = 'coef', value ='val', GPE_low, GPE_high) %>%
  group_by(item, ROI , coef) %>%
  summarise(mean = mean(val),
            lower = quantile(val, 0.025)[[1]], 
            upper = quantile(val, 0.975)[[1]])
write.csv(by_item_gpt2, "by_item_gpt2.csv")
saveRDS(by_item_gpt2, "by_item_gpt2.rds")

# by construction
by_construction_gpt2 <- reshape_item_output_gpt2[,c('.draw', 'ROI', colnames(reshape_item_output_gpt2)[str_detect(colnames(reshape_item_output_gpt2),'b')])] %>% 
  unique() %>%
  mutate(GPE_low = -b_ambiguity + (-1/2)*b_height,
         GPE_high = -b_ambiguity + (1/2)*b_height) %>%
  select(`.draw`, ROI, GPE_low,GPE_high) %>% 
  gather(key='coef',value='val', GPE_low, GPE_high)%>%
  group_by(ROI, coef)%>%
  summarise(mean=mean(val),
            lower=quantile(val,0.025)[[1]],
            upper=quantile(val,0.975)[[1]])
by_construction_gpt2$ROI <- as.character(by_construction_gpt2$ROI)
write.csv(by_construction_gpt2, "by_construction_gpt2.csv")
saveRDS(by_construction_gpt2, "by_construction_gpt2.rds")
```










# lmer models
```{r}
# contrasts
rt.data$ambiguity <- ifelse(
  rt.data$AMBIG=="Amb",2/3,-1/3)

rt.data <- rt.data %>% 
  mutate(height = case_when(Type=="AttachMulti" ~ 0, 
                            Type=="AttachLow" ~ -1/2,
                            Type=="AttachHigh" ~ 1/2))

lmer_emp_0 <- lmer(RT ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                   data=rt.data[rt.data$ROI==0,],
                   control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_emp_0)
saveRDS(lmer_emp_0, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_emp_0.rds")

lmer_emp_1 <- lmer(RT ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                   data=rt.data[rt.data$ROI==1,],
                   control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_emp_1)
saveRDS(lmer_emp_1, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_emp_1.rds")

lmer_emp_2 <- lmer(RT ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                   data=rt.data[rt.data$ROI==2,],
                   control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_emp_2)
saveRDS(lmer_emp_2, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_emp_2.rds")

#extract all fixed and random factors
## ROI=0 ##
fixed_ambiguity <- fixef(lmer_emp_0)[2]
fixed_height <- fixef(lmer_emp_0)[3]
se_ambiguity <- coef(summary(lmer_emp_0))[2, "Std. Error"]
se_height <- coef(summary(lmer_emp_0))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_emp_0)[['item']]$ambiguity
random_height <- ranef(lmer_emp_0)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_0 <- rbind(data.frame(
  item=rownames(ranef(lmer_emp_0)[['item']]),
  ROI="0",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_emp_0)[['item']]),
  ROI="0",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_0 <- data.frame(
  ROI="0",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)

## ROI=1 ##
fixed_ambiguity <- fixef(lmer_emp_1)[2]
fixed_height <- fixef(lmer_emp_1)[3]
se_ambiguity <- coef(summary(lmer_emp_1))[2, "Std. Error"]
se_height <- coef(summary(lmer_emp_1))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_emp_1)[['item']]$ambiguity
random_height <- ranef(lmer_emp_1)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_1 <- rbind(data.frame(
  item=rownames(ranef(lmer_emp_1)[['item']]),
  ROI="1",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_emp_1)[['item']]),
  ROI="1",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_1 <- data.frame(
  ROI="1",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)

## ROI=2 ##
fixed_ambiguity <- fixef(lmer_emp_2)[2]
fixed_height <- fixef(lmer_emp_2)[3]
se_ambiguity <- coef(summary(lmer_emp_2))[2, "Std. Error"]
se_height <- coef(summary(lmer_emp_2))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_emp_2)[['item']]$ambiguity
random_height <- ranef(lmer_emp_2)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_2 <- rbind(data.frame(
  item=rownames(ranef(lmer_emp_2)[['item']]),
  ROI="2",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_emp_2)[['item']]),
  ROI="2",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_2 <- data.frame(
  ROI="2",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)


by_item_lmer <- rbind(by_item_lmer_0, by_item_lmer_1, by_item_lmer_2)
saveRDS(by_item_lmer, "/Users/mkugemoto/Documents/GitHub/sap_local/by_item_lmer.rds")

by_construction_lmer <- rbind(by_construction_lmer_0, by_construction_lmer_1, by_construction_lmer_2)
saveRDS(by_construction_lmer, "/Users/mkugemoto/Documents/GitHub/sap_local/by_construction_lmer.rds")



## lstm ##
# contrasts
attach_pred_lstm$ambiguity <- ifelse(
  attach_pred_lstm$AMBIG=="Amb",2/3,-1/3)

attach_pred_lstm <- attach_pred_lstm %>% 
  mutate(height = case_when(Type=="AttachMulti" ~ 0, 
                            Type=="AttachLow" ~ -1/2,
                            Type=="AttachHigh" ~ 1/2))


lmer_pred_lstm_0 <- lmer(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                         data=attach_pred_lstm[attach_pred_lstm$ROI==0,],
                         control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_pred_lstm_0)
saveRDS(lmer_pred_lstm_0, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_pred_lstm_0.rds")

lmer_pred_lstm_1 <- lmer(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                         data=attach_pred_lstm[attach_pred_lstm$ROI==1,],
                         control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_pred_lstm_1)
saveRDS(lmer_pred_lstm_1, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_pred_lstm_1.rds")

lmer_pred_lstm_2 <- lmer(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                         data=attach_pred_lstm[attach_pred_lstm$ROI==2,],
                         control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_pred_lstm_2)
saveRDS(lmer_pred_lstm_2, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_pred_lstm_2.rds")

#extract all fixed and random factors
## ROI=0 ##
fixed_ambiguity <- fixef(lmer_pred_lstm_0)[2]
fixed_height <- fixef(lmer_pred_lstm_0)[3]
se_ambiguity <- coef(summary(lmer_pred_lstm_0))[2, "Std. Error"]
se_height <- coef(summary(lmer_pred_lstm_0))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_pred_lstm_0)[['item']]$ambiguity
random_height <- ranef(lmer_pred_lstm_0)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height 
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height 
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_lstm_0 <- rbind(data.frame(
  item=rownames(ranef(lmer_pred_lstm_0)[['item']]),
  ROI="0",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_pred_lstm_0)[['item']]),
  ROI="0",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_lstm_0 <- data.frame(
  ROI="0",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)


## ROI=1 ##
fixed_ambiguity <- fixef(lmer_pred_lstm_1)[2]
fixed_height <- fixef(lmer_pred_lstm_1)[3]
se_ambiguity <- coef(summary(lmer_pred_lstm_1))[2, "Std. Error"]
se_height <- coef(summary(lmer_pred_lstm_1))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_pred_lstm_1)[['item']]$ambiguity
random_height <- ranef(lmer_pred_lstm_1)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height 
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height 
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_lstm_1 <- rbind(data.frame(
  item=rownames(ranef(lmer_pred_lstm_1)[['item']]),
  ROI="1",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_pred_lstm_1)[['item']]),
  ROI="1",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_lstm_1 <- data.frame(
  ROI="1",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)

## ROI=2 ##
fixed_ambiguity <- fixef(lmer_pred_lstm_2)[2]
fixed_height <- fixef(lmer_pred_lstm_2)[3]
se_ambiguity <- coef(summary(lmer_pred_lstm_2))[2, "Std. Error"]
se_height <- coef(summary(lmer_pred_lstm_2))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_pred_lstm_2)[['item']]$ambiguity
random_height <- ranef(lmer_pred_lstm_2)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height 
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height 
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_lstm_2 <- rbind(data.frame(
  item=rownames(ranef(lmer_pred_lstm_2)[['item']]),
  ROI="2",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_pred_lstm_2)[['item']]),
  ROI="2",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_lstm_2 <- data.frame(
  ROI="2",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)

by_item_lmer_lstm <- rbind(by_item_lmer_lstm_0, by_item_lmer_lstm_1, by_item_lmer_lstm_2)
saveRDS(by_item_lmer_lstm, "/Users/mkugemoto/Documents/GitHub/sap_local/by_item_lmer_lstm.rds")

by_construction_lmer_lstm <- rbind(by_construction_lmer_lstm_0, by_construction_lmer_lstm_1, by_construction_lmer_lstm_2)
saveRDS(by_construction_lmer_lstm, "/Users/mkugemoto/Documents/GitHub/sap_local/by_construction_lmer_lstm.rds")

## gpt2 ##
# contrasts
attach_pred_gpt2$ambiguity <- ifelse(
  attach_pred_gpt2$AMBIG=="Amb",2/3,-1/3)

attach_pred_gpt2 <- attach_pred_gpt2 %>% 
  mutate(height = case_when(Type=="AttachMulti" ~ 0, 
                            Type=="AttachLow" ~ -1/2,
                            Type=="AttachHigh" ~ 1/2))


lmer_pred_gpt2_0 <- lmer(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                         data=attach_pred_gpt2[attach_pred_gpt2$ROI==0,],
                         control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_pred_gpt2_0)
saveRDS(lmer_pred_gpt2_0, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_pred_gpt2_0.rds")

lmer_pred_gpt2_1 <- lmer(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                         data=attach_pred_gpt2[attach_pred_gpt2$ROI==1,],
                         control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_pred_gpt2_1)
saveRDS(lmer_pred_gpt2_1, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_pred_gpt2_1.rds")

lmer_pred_gpt2_2 <- lmer(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                         data=attach_pred_gpt2[attach_pred_gpt2$ROI==2,],
                         control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_pred_gpt2_2)
saveRDS(lmer_pred_gpt2_2, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_pred_gpt2_2.rds")


## ROI=0 ##
fixed_ambiguity <- fixef(lmer_pred_gpt2_0)[2]
fixed_height <- fixef(lmer_pred_gpt2_0)[3]
se_ambiguity <- coef(summary(lmer_pred_gpt2_0))[2, "Std. Error"]
se_height <- coef(summary(lmer_pred_gpt2_0))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_pred_gpt2_0)[['item']]$ambiguity
random_height <- ranef(lmer_pred_gpt2_0)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height 
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height 
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_gpt2_0 <- rbind(data.frame(
  item=rownames(ranef(lmer_pred_gpt2_0)[['item']]),
  ROI="0",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_pred_gpt2_0)[['item']]),
  ROI="0",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_gpt2_0 <- data.frame(
  ROI="0",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)

## ROI=1 ##
fixed_ambiguity <- fixef(lmer_pred_gpt2_1)[2]
fixed_height <- fixef(lmer_pred_gpt2_1)[3]
se_ambiguity <- coef(summary(lmer_pred_gpt2_1))[2, "Std. Error"]
se_height <- coef(summary(lmer_pred_gpt2_1))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_pred_gpt2_1)[['item']]$ambiguity
random_height <- ranef(lmer_pred_gpt2_1)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height 
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height 
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_gpt2_1 <- rbind(data.frame(
  item=rownames(ranef(lmer_pred_gpt2_1)[['item']]),
  ROI="1",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_pred_gpt2_1)[['item']]),
  ROI="1",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_gpt2_1 <- data.frame(
  ROI="1",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)

## ROI=2 ##
fixed_ambiguity <- fixef(lmer_pred_gpt2_2)[2]
fixed_height <- fixef(lmer_pred_gpt2_2)[3]
se_ambiguity <- coef(summary(lmer_pred_gpt2_2))[2, "Std. Error"]
se_height <- coef(summary(lmer_pred_gpt2_2))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_pred_gpt2_2)[['item']]$ambiguity
random_height <- ranef(lmer_pred_gpt2_2)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height 
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height 
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_gpt2_2 <- rbind(data.frame(
  item=rownames(ranef(lmer_pred_gpt2_2)[['item']]),
  ROI="2",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_pred_gpt2_2)[['item']]),
  ROI="2",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_gpt2_2 <- data.frame(
  ROI="2",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)


by_item_lmer_gpt2 <- rbind(by_item_lmer_gpt2_0, by_item_lmer_gpt2_1, by_item_lmer_gpt2_2)
saveRDS(by_item_lmer_gpt2, "/Users/mkugemoto/Documents/GitHub/sap_local/by_item_lmer_gpt2.rds")

by_construction_lmer_gpt2 <- rbind(by_construction_lmer_gpt2_0, by_construction_lmer_gpt2_1, by_construction_lmer_gpt2_2)
saveRDS(by_construction_lmer_gpt2, "/Users/mkugemoto/Documents/GitHub/sap_local/by_construction_lmer_gpt2.rds")
```


### correlation plot
```{r}
colnames(by_item_lmer)[which(names(by_item_lmer) == "mean")] <- "human"
colnames(by_item_lmer_gpt2)[which(names(by_item_lmer_gpt2) == "mean")] <- "gpt2"
colnames(by_item_lmer_lstm)[which(names(by_item_lmer_lstm) == "mean")] <- "lstm"

merged_by_item <- merge(merge(by_item_lmer, by_item_lmer_gpt2, by=c("item", "ROI", "coef")), 
                        by_item_lmer_lstm, by=c("item", "ROI", "coef"))

plot(merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='1', "human"], merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='1', "gpt2"], main="gpt2, high attachment")
plot(merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='0', "human"], merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='0', "gpt2"], main="gpt2, low attachment")
cor(merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='0', "human"], merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='0', "gpt2"])
cor(merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='0', "human"], merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='0', "gpt2"])
cor(merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='1', "human"], merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='1', "gpt2"])
cor(merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='1', "human"], merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='1', "gpt2"])
cor(merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='2', "human"], merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='2', "gpt2"])
cor(merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='2', "human"], merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='2', "gpt2"])

plot(merged_by_item[merged_by_item$coef=="GPE_high"& merged_by_item$ROI=='1', "human"], merged_by_item[merged_by_item$coef=="GPE_high"& merged_by_item$ROI=='1', "lstm"], main="lstm, high attachment")
plot(merged_by_item[merged_by_item$coef=="GPE_low"& merged_by_item$ROI=='0', "human"], merged_by_item[merged_by_item$coef=="GPE_low"& merged_by_item$ROI=='0', "lstm"], main="lstm, low attachment")
cor(merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='0', "human"], merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='0', "lstm"])
cor(merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='0', "human"], merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='0', "lstm"])
cor(merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='1', "human"], merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='1', "lstm"])
cor(merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='1', "human"], merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='1', "lstm"])
cor(merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='2', "human"], merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='2', "lstm"])
cor(merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='2', "human"], merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='2', "lstm"])
```





