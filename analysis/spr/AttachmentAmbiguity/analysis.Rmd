---
title: "demo_attachment"
author: "Mari Kugemoto"
date: "5/20/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## set up
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(tidyr)
library(lme4)
library(lmerTest)
library(stringr)
library(brms)
library(tidybayes)

# set the directory
setwd('~/Documents/GitHub/sapbenchmark/')

# load the shared functions
source("/Users/mkugemoto/Documents/GitHub/sapbenchmark/analysis/shared/util.R")
```

## brms models
prior1 <- c(prior("normal(300,1000)", class = "Intercept"),
            prior("normal(0,150)", class = "b"),  
            prior("normal(0,200)", class = "sd"),  #brms automatically truncates the dist.  
            prior("normal(0,500)", class = "sigma"))
### ROI=0
brm_prior1_0 <- brm(RT ~ ambiguity + height + (1+ambiguity+height||item) + (1+height+ambiguity||participant),
                    data=subset(rt.data, rt.data$ROI==0),
                    cores = 4,
                    prior = prior1,
                    iter = 6000,
                    control = list(adapt_delta = 0.9),
                    seed = 117)
save(brm_prior1_0, file="brm_prior1_0.RData")

### ROI=1
brm_prior1_1 <- brm(RT ~ ambiguity + height + (1+ambiguity+height||item) + (1+height+ambiguity||participant),
                    data=subset(rt.data, rt.data$ROI==1),
                    cores = 4,
                    prior = prior1,
                    iter = 6000,
                    control = list(adapt_delta = 0.9),
                    seed = 117)
save(brm_prior1_1, file="brm_prior1_1.RData")

### ROI=2
brm_prior1_2 <- brm(RT ~ ambiguity + height + (1+ambiguity+height||item) + (1+height+ambiguity||participant),
                    data=subset(rt.data, rt.data$ROI==2),
                    cores = 4,
                    prior = prior1,
                    iter = 6000,
                    control = list(adapt_delta = 0.9),
                    seed = 117)
save(brm_prior1_2, file="brm_prior1_2.RData")

# brms
## load the data
```{r}
rt.data <- load_data("AttachmentAmbiguity")


# function to read and name .RData
loadRData <- function(fileName){
  #loads an RData file, and returns it
  load(fileName)
  get(ls()[ls() != "fileName"])
}

brm_prior1_0 <- loadRData("brm_prior1_0.RData")
brm_prior1_1 <- loadRData("brm_prior1_1.RData")
brm_prior1_2 <- loadRData("brm_prior1_2.RData")

summary(brm_prior1_0)
summary(brm_prior1_1)
summary(brm_prior1_2)
```

## predict RTs
```{r}
setwd('~/Documents/GitHub/sapbenchmark/')
# lstm
attach_pred_lstm <- Predicting_RT_with_spillover(rt.data, "AttachmentAmbiguity", "lstm")

# gpt2
attach_pred_gpt2 <- Predicting_RT_with_spillover(rt.data, "AttachmentAmbiguity", "gpt2")
```

## extract posterior estimates (no need to run this again)
```{r}
# extract posterior estimates
#reshaped_item_dat_attach_0 <- reshape_item_dat(brm_prior1_0, "item")
#reshaped_item_dat_attach_1 <- reshape_item_dat(brm_prior1_1, "item")
#reshaped_item_dat_attach_2 <- reshape_item_dat(brm_prior1_2, "item")

# save them
#saveRDS(reshaped_item_dat_attach_0, "reshaped_item_dat_attach_0.rds")
#saveRDS(reshaped_item_dat_attach_1, "reshaped_item_dat_attach_1.rds")
#saveRDS(reshaped_item_dat_attach_2, "reshaped_item_dat_attach_2.rds")
```

```{r}
# load the data (reshaped_item_dat)
reshape_item_output_P0 <- readRDS("reshaped_item_dat_attach_0.rds") 
reshape_item_output_P0$ROI <- 0
reshape_item_output_P1 <- readRDS("reshaped_item_dat_attach_1.rds") 
reshape_item_output_P1$ROI <- 1
reshape_item_output_P2 <- readRDS("reshaped_item_dat_attach_2.rds")
reshape_item_output_P2$ROI <- 2
reshape_item_output <- rbind(reshape_item_output_P0,reshape_item_output_P1,reshape_item_output_P2)
reshape_item_output$item <- as.numeric(reshape_item_output$item)

# by item
by_item <- reshape_item_output %>%
  mutate(GPE_low = -b_ambiguity + (-1/2)*b_height -r_ambiguity + (-1/2)*r_height,
         GPE_high = -b_ambiguity + (1/2)*b_height -r_ambiguity + (1/2)*r_height
         ) %>%
  select(`.chain`, `.draw`, `.iteration`, item, ROI, GPE_low, GPE_high) %>% 
  gather(key = 'coef', value ='val', GPE_low, GPE_high) %>%
  group_by(item, ROI , coef) %>%
  summarise(mean = mean(val),
            lower = quantile(val, 0.025)[[1]], 
            upper = quantile(val, 0.975)[[1]])
#write.csv(by_item, "by_item.csv")

# by construction
by_construction <- reshape_item_output[,c('.draw', 'ROI', colnames(reshape_item_output)[str_detect(colnames(reshape_item_output),'b')])] %>% 
  unique() %>%
  mutate(GPE_low = -b_ambiguity + (-1/2)*b_height,
         GPE_high = -b_ambiguity + (1/2)*b_height) %>%
  select(`.draw`, ROI, GPE_low,GPE_high) %>% 
  gather(key='coef',value='val', GPE_low, GPE_high)%>%
  group_by(ROI, coef)%>%
  summarise(mean=mean(val),
            lower=quantile(val,0.025)[[1]],
            upper=quantile(val,0.975)[[1]])
by_construction$ROI <- as.character(by_construction$ROI)
#write.csv(by_construction, "by_construction.csv")
```

## plot
```{r}
Plot_empirical_construction_level(by_construction,"AttachmentAmbiguity")

Plot_itemwise_by_magnitude(by_item,"AttachmentAmbiguity",ROI=0)
Plot_itemwise_by_magnitude(by_item,"AttachmentAmbiguity",ROI=1)
Plot_itemwise_by_magnitude(by_item,"AttachmentAmbiguity",ROI=2)
```

### surprisals
```{r}
merged_surp <- merge_surprisal(rt.data, by_item, "AttachmentAmbiguity")
```



### brms models (predicted)

# load the data
```{r}
attach_pred_lstm <- attach_pred_lstm %>% 
  filter(predicted <= 7000) %>% 
  filter(predicted>0) %>% 
  mutate(participant=MD5)
attach_pred_lstm$Sentence <- str_replace_all(attach_pred_lstm$Sentence, "%2C", ",")

# contrasts
attach_pred_lstm$ambiguity <- ifelse(
  attach_pred_lstm$AMBIG=="Amb",2/3,-1/3)

attach_pred_lstm <- attach_pred_lstm %>% 
  mutate(height = case_when(Type=="AttachMulti" ~ 0, 
                            Type=="AttachLow" ~ -1/2,
                            Type=="AttachHigh" ~ 1/2))

# gpt2
attach_pred_gpt2 <- attach_pred_gpt2 %>% 
  filter(predicted <= 7000) %>% 
  filter(predicted>0) %>% 
  mutate(participant=MD5)
attach_pred_gpt2$Sentence <- str_replace_all(attach_pred_gpt2$Sentence, "%2C", ",")

# contrasts
attach_pred_gpt2$ambiguity <- ifelse(
  attach_pred_gpt2$AMBIG=="Amb",2/3,-1/3)

attach_pred_gpt2 <- attach_pred_gpt2 %>% 
  mutate(height = case_when(Type=="AttachMulti" ~ 0, 
                            Type=="AttachLow" ~ -1/2,
                            Type=="AttachHigh" ~ 1/2))
```

```{r}
## brms models
prior1 <- c(prior("normal(300,1000)", class = "Intercept"),
            prior("normal(0,150)", class = "b"),  
            prior("normal(0,200)", class = "sd"),  #brms automatically truncates the dist.  
            prior("normal(0,500)", class = "sigma"))

### ROI=0, lstm
brm_prior1_pred_lstm_0 <- brm(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                    data=subset(attach_pred_lstm, attach_pred_lstm$ROI==0),
                    cores = 4,
                    prior = prior1,
                    iter = 12000,
                    control = list(adapt_delta = 0.8),
                    seed = 117,
                    warmup=6000)
save(brm_prior1_pred_lstm_0, file="brm_prior1_pred_lstm_0.RData")

### ROI=1, lstm
brm_prior1_pred_lstm_1 <- brm(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                    data=subset(attach_pred_lstm, attach_pred_lstm$ROI==1),
                    cores = 4,
                    prior = prior1,
                    iter = 12000,
                    control = list(adapt_delta = 0.8),
                    seed = 117,
                    warmup=6000)
save(brm_prior1_pred_lstm_1, file="brm_prior1_pred_lstm_1.RData")

### ROI=2, lstm
brm_prior1_pred_lstm_2 <- brm(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                    data=subset(attach_pred_lstm, attach_pred_lstm$ROI==2),
                    cores = 4,
                    prior = prior1,
                    iter = 12000,
                    control = list(adapt_delta = 0.8),
                    seed = 117,
                    warmup=6000)
save(brm_prior1_pred_lstm_2, file="brm_prior1_pred_lstm_2.RData")

### ROI=0, gpt2
brm_prior1_pred_gpt2_0 <- brm(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                    data=subset(attach_pred_gpt2, attach_pred_gpt2$ROI==0),
                    cores = 4,
                    prior = prior1,
                    iter = 12000,
                    control = list(adapt_delta = 0.8),
                    seed = 117,
                    warmup=6000)
save(brm_prior1_pred_gpt2_0, file="brm_prior1_pred_gpt2_0.RData")

### ROI=1, gpt2
brm_prior1_pred_gpt2_1 <- brm(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                    data=subset(attach_pred_gpt2, attach_pred_gpt2$ROI==1),
                    cores = 4,
                    prior = prior1,
                    iter = 12000,
                    control = list(adapt_delta = 0.8),
                    seed = 117,
                    warmup=6000)
save(brm_prior1_pred_gpt2_1, file="brm_prior1_pred_gpt2_1.RData")

### ROI=2, gpt2
brm_prior1_pred_gpt2_2 <- brm(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                    data=subset(attach_pred_gpt2, attach_pred_gpt2$ROI==2),
                    cores = 4,
                    prior = prior1,
                    iter = 12000,
                    control = list(adapt_delta = 0.8),
                    seed = 117,
                    warmup=6000)
save(brm_prior1_pred_gpt2_2, file="brm_prior1_pred_gpt2_2.RData")
```

## extract posterior estimates (no need to run this again)
```{r}
## lstm
# extract posterior estimates
reshaped_item_dat_attach_pred_lstm_0 <- reshape_item_dat(brm_prior1_pred_lstm_0, "item")
reshaped_item_dat_attach_pred_lstm_1 <- reshape_item_dat(brm_prior1_pred_lstm_1, "item")
reshaped_item_dat_attach_pred_lstm_2 <- reshape_item_dat(brm_prior1_pred_lstm_2, "item")

# save them
saveRDS(reshaped_item_dat_attach_pred_lstm_0, "reshaped_item_dat_attach_pred_lstm_0.rds")
saveRDS(reshaped_item_dat_attach_pred_lstm_1, "reshaped_item_dat_attach_pred_lstm_1.rds")
saveRDS(reshaped_item_dat_attach_pred_lstm_2, "reshaped_item_dat_attach_pred_lstm_2.rds")

## gpt2
# extract posterior estimates
reshaped_item_dat_attach_pred_gpt2_0 <- reshape_item_dat(brm_prior1_pred_gpt2_0, "item")
reshaped_item_dat_attach_pred_gpt2_1 <- reshape_item_dat(brm_prior1_pred_gpt2_1, "item")
reshaped_item_dat_attach_pred_gpt2_2 <- reshape_item_dat(brm_prior1_pred_gpt2_2, "item")

# save them
saveRDS(reshaped_item_dat_attach_pred_gpt2_0, "reshaped_item_dat_attach_pred_gpt2_0.rds")
saveRDS(reshaped_item_dat_attach_pred_gpt2_1, "reshaped_item_dat_attach_pred_gpt2_1.rds")
saveRDS(reshaped_item_dat_attach_pred_gpt2_2, "reshaped_item_dat_attach_pred_gpt2_2.rds")
```

```{r}
# load the data (reshaped_item_dat)
reshape_item_output_P0 <- readRDS("reshaped_item_dat_attach_pred_lstm_0.rds") 
reshape_item_output_P0$ROI <- 0
reshape_item_output_P1 <- readRDS("reshaped_item_dat_attach_pred_lstm_1.rds") 
reshape_item_output_P1$ROI <- 1
reshape_item_output_P2 <- readRDS("reshaped_item_dat_attach_pred_lstm_2.rds")
reshape_item_output_P2$ROI <- 2
reshape_item_output_lstm <- rbind(reshape_item_output_P0,reshape_item_output_P1,reshape_item_output_P2)
reshape_item_output_lstm$item <- as.numeric(reshape_item_output_lstm$item)

# by item
by_item_lstm <- reshape_item_output_lstm %>%
  mutate(GPE_low = -b_ambiguity + (-1/2)*b_height -r_ambiguity + (-1/2)*r_height,
         GPE_high = -b_ambiguity + (1/2)*b_height -r_ambiguity + (1/2)*r_height
         ) %>%
  select(`.chain`, `.draw`, `.iteration`, item, ROI, GPE_low, GPE_high) %>% 
  gather(key = 'coef', value ='val', GPE_low, GPE_high) %>%
  group_by(item, ROI , coef) %>%
  summarise(mean = mean(val),
            lower = quantile(val, 0.025)[[1]], 
            upper = quantile(val, 0.975)[[1]])
saveRDS(by_item_lstm, "by_item_lstm.rds")

# by construction
by_construction_lstm <- reshape_item_output_lstm[,c('.draw', 'ROI', colnames(reshape_item_output_lstm)[str_detect(colnames(reshape_item_output_lstm),'b')])] %>% 
  unique() %>%
  mutate(GPE_low = -b_ambiguity + (-1/2)*b_height,
         GPE_high = -b_ambiguity + (1/2)*b_height) %>%
  select(`.draw`, ROI, GPE_low,GPE_high) %>% 
  gather(key='coef',value='val', GPE_low, GPE_high)%>%
  group_by(ROI, coef)%>%
  summarise(mean=mean(val),
            lower=quantile(val,0.025)[[1]],
            upper=quantile(val,0.975)[[1]])
by_construction_lstm$ROI <- as.character(by_construction_lstm$ROI)
write.csv(by_construction_lstm, "by_construction_lstm.csv")
saveRDS(by_construction_lstm, "by_construction_lstm.rds")


## gpt2 ##
# load the data (reshaped_item_dat)
reshape_item_output_P0 <- readRDS("reshaped_item_dat_attach_pred_gpt2_0.rds") 
reshape_item_output_P0$ROI <- 0
reshape_item_output_P1 <- readRDS("reshaped_item_dat_attach_pred_gpt2_1.rds") 
reshape_item_output_P1$ROI <- 1
reshape_item_output_P2 <- readRDS("reshaped_item_dat_attach_pred_gpt2_2.rds")
reshape_item_output_P2$ROI <- 2
reshape_item_output_gpt2 <- rbind(reshape_item_output_P0,reshape_item_output_P1,reshape_item_output_P2)
reshape_item_output_gpt2$item <- as.numeric(reshape_item_output_gpt2$item)

# by item
by_item_gpt2 <- reshape_item_output_gpt2 %>%
  mutate(GPE_low = -b_ambiguity + (-1/2)*b_height -r_ambiguity + (-1/2)*r_height,
         GPE_high = -b_ambiguity + (1/2)*b_height -r_ambiguity + (1/2)*r_height
         ) %>%
  select(`.chain`, `.draw`, `.iteration`, item, ROI, GPE_low, GPE_high) %>% 
  gather(key = 'coef', value ='val', GPE_low, GPE_high) %>%
  group_by(item, ROI , coef) %>%
  summarise(mean = mean(val),
            lower = quantile(val, 0.025)[[1]], 
            upper = quantile(val, 0.975)[[1]])
write.csv(by_item_gpt2, "by_item_gpt2.csv")
saveRDS(by_item_gpt2, "by_item_gpt2.rds")

# by construction
by_construction_gpt2 <- reshape_item_output_gpt2[,c('.draw', 'ROI', colnames(reshape_item_output_gpt2)[str_detect(colnames(reshape_item_output_gpt2),'b')])] %>% 
  unique() %>%
  mutate(GPE_low = -b_ambiguity + (-1/2)*b_height,
         GPE_high = -b_ambiguity + (1/2)*b_height) %>%
  select(`.draw`, ROI, GPE_low,GPE_high) %>% 
  gather(key='coef',value='val', GPE_low, GPE_high)%>%
  group_by(ROI, coef)%>%
  summarise(mean=mean(val),
            lower=quantile(val,0.025)[[1]],
            upper=quantile(val,0.975)[[1]])
by_construction_gpt2$ROI <- as.character(by_construction_gpt2$ROI)
write.csv(by_construction_gpt2, "by_construction_gpt2.csv")
saveRDS(by_construction_gpt2, "by_construction_gpt2.rds")
```










# lmer models
```{r}
# contrasts
rt.data$ambiguity <- ifelse(
  rt.data$AMBIG=="Amb",2/3,-1/3)

rt.data <- rt.data %>% 
  mutate(height = case_when(Type=="AttachMulti" ~ 0, 
                            Type=="AttachLow" ~ -1/2,
                            Type=="AttachHigh" ~ 1/2))

lmer_emp_0 <- lmer(RT ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                   data=rt.data[rt.data$ROI==0,],
                   control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_emp_0)
saveRDS(lmer_emp_0, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_emp_0.rds")

lmer_emp_1 <- lmer(RT ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                   data=rt.data[rt.data$ROI==1,],
                   control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_emp_1)
saveRDS(lmer_emp_1, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_emp_1.rds")

lmer_emp_2 <- lmer(RT ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                   data=rt.data[rt.data$ROI==2,],
                   control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_emp_2)
saveRDS(lmer_emp_2, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_emp_2.rds")

#extract all fixed and random factors
## ROI=0 ##
fixed_ambiguity <- fixef(lmer_emp_0)[2]
fixed_height <- fixef(lmer_emp_0)[3]
se_ambiguity <- coef(summary(lmer_emp_0))[2, "Std. Error"]
se_height <- coef(summary(lmer_emp_0))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_emp_0)[['item']]$ambiguity
random_height <- ranef(lmer_emp_0)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_0 <- rbind(data.frame(
  item=rownames(ranef(lmer_emp_0)[['item']]),
  ROI="0",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_emp_0)[['item']]),
  ROI="0",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_0 <- data.frame(
  ROI="0",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)

## ROI=1 ##
fixed_ambiguity <- fixef(lmer_emp_1)[2]
fixed_height <- fixef(lmer_emp_1)[3]
se_ambiguity <- coef(summary(lmer_emp_1))[2, "Std. Error"]
se_height <- coef(summary(lmer_emp_1))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_emp_1)[['item']]$ambiguity
random_height <- ranef(lmer_emp_1)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_1 <- rbind(data.frame(
  item=rownames(ranef(lmer_emp_1)[['item']]),
  ROI="1",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_emp_1)[['item']]),
  ROI="1",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_1 <- data.frame(
  ROI="1",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)

## ROI=2 ##
fixed_ambiguity <- fixef(lmer_emp_2)[2]
fixed_height <- fixef(lmer_emp_2)[3]
se_ambiguity <- coef(summary(lmer_emp_2))[2, "Std. Error"]
se_height <- coef(summary(lmer_emp_2))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_emp_2)[['item']]$ambiguity
random_height <- ranef(lmer_emp_2)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_2 <- rbind(data.frame(
  item=rownames(ranef(lmer_emp_2)[['item']]),
  ROI="2",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_emp_2)[['item']]),
  ROI="2",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_2 <- data.frame(
  ROI="2",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)


by_item_lmer <- rbind(by_item_lmer_0, by_item_lmer_1, by_item_lmer_2)
saveRDS(by_item_lmer, "/Users/mkugemoto/Documents/GitHub/sap_local/by_item_lmer.rds")

by_construction_lmer <- rbind(by_construction_lmer_0, by_construction_lmer_1, by_construction_lmer_2)
saveRDS(by_construction_lmer, "/Users/mkugemoto/Documents/GitHub/sap_local/by_construction_lmer.rds")



## lstm ##
attach_pred_lstm <- filter(attach_pred_lstm, !is.na(attach_pred_lstm$RT))
# contrasts
attach_pred_lstm$ambiguity <- ifelse(
  attach_pred_lstm$AMBIG=="Amb",2/3,-1/3)

attach_pred_lstm <- attach_pred_lstm %>% 
  mutate(height = case_when(Type=="AttachMulti" ~ 0, 
                            Type=="AttachLow" ~ -1/2,
                            Type=="AttachHigh" ~ 1/2))


lmer_pred_lstm_0 <- lmer(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                         data=attach_pred_lstm[attach_pred_lstm$ROI==0,],
                         control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_pred_lstm_0)
saveRDS(lmer_pred_lstm_0, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_pred_lstm_0.rds")

lmer_pred_lstm_1 <- lmer(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                         data=attach_pred_lstm[attach_pred_lstm$ROI==1,],
                         control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_pred_lstm_1)
saveRDS(lmer_pred_lstm_1, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_pred_lstm_1.rds")

lmer_pred_lstm_2 <- lmer(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                         data=attach_pred_lstm[attach_pred_lstm$ROI==2,],
                         control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_pred_lstm_2)
saveRDS(lmer_pred_lstm_2, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_pred_lstm_2.rds")

#extract all fixed and random factors
## ROI=0 ##
fixed_ambiguity <- fixef(lmer_pred_lstm_0)[2]
fixed_height <- fixef(lmer_pred_lstm_0)[3]
se_ambiguity <- coef(summary(lmer_pred_lstm_0))[2, "Std. Error"]
se_height <- coef(summary(lmer_pred_lstm_0))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_pred_lstm_0)[['item']]$ambiguity
random_height <- ranef(lmer_pred_lstm_0)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height 
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height 
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_lstm_0 <- rbind(data.frame(
  item=rownames(ranef(lmer_pred_lstm_0)[['item']]),
  ROI="0",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_pred_lstm_0)[['item']]),
  ROI="0",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_lstm_0 <- data.frame(
  ROI="0",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)


## ROI=1 ##
fixed_ambiguity <- fixef(lmer_pred_lstm_1)[2]
fixed_height <- fixef(lmer_pred_lstm_1)[3]
se_ambiguity <- coef(summary(lmer_pred_lstm_1))[2, "Std. Error"]
se_height <- coef(summary(lmer_pred_lstm_1))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_pred_lstm_1)[['item']]$ambiguity
random_height <- ranef(lmer_pred_lstm_1)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height 
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height 
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_lstm_1 <- rbind(data.frame(
  item=rownames(ranef(lmer_pred_lstm_1)[['item']]),
  ROI="1",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_pred_lstm_1)[['item']]),
  ROI="1",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_lstm_1 <- data.frame(
  ROI="1",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)

## ROI=2 ##
fixed_ambiguity <- fixef(lmer_pred_lstm_2)[2]
fixed_height <- fixef(lmer_pred_lstm_2)[3]
se_ambiguity <- coef(summary(lmer_pred_lstm_2))[2, "Std. Error"]
se_height <- coef(summary(lmer_pred_lstm_2))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_pred_lstm_2)[['item']]$ambiguity
random_height <- ranef(lmer_pred_lstm_2)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height 
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height 
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_lstm_2 <- rbind(data.frame(
  item=rownames(ranef(lmer_pred_lstm_2)[['item']]),
  ROI="2",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_pred_lstm_2)[['item']]),
  ROI="2",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_lstm_2 <- data.frame(
  ROI="2",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)

by_item_lmer_lstm <- rbind(by_item_lmer_lstm_0, by_item_lmer_lstm_1, by_item_lmer_lstm_2)
saveRDS(by_item_lmer_lstm, "/Users/mkugemoto/Documents/GitHub/sap_local/by_item_lmer_lstm.rds")

by_construction_lmer_lstm <- rbind(by_construction_lmer_lstm_0, by_construction_lmer_lstm_1, by_construction_lmer_lstm_2)
saveRDS(by_construction_lmer_lstm, "/Users/mkugemoto/Documents/GitHub/sap_local/by_construction_lmer_lstm.rds")

## gpt2 ##
attach_pred_gpt2 <- filter(attach_pred_gpt2, !is.na(attach_pred_gpt2$RT))
# contrasts
attach_pred_gpt2$ambiguity <- ifelse(
  attach_pred_gpt2$AMBIG=="Amb",2/3,-1/3)

attach_pred_gpt2 <- attach_pred_gpt2 %>% 
  mutate(height = case_when(Type=="AttachMulti" ~ 0, 
                            Type=="AttachLow" ~ -1/2,
                            Type=="AttachHigh" ~ 1/2))


lmer_pred_gpt2_0 <- lmer(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                         data=attach_pred_gpt2[attach_pred_gpt2$ROI==0,],
                         control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_pred_gpt2_0)
saveRDS(lmer_pred_gpt2_0, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_pred_gpt2_0.rds")

lmer_pred_gpt2_1 <- lmer(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                         data=attach_pred_gpt2[attach_pred_gpt2$ROI==1,],
                         control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_pred_gpt2_1)
saveRDS(lmer_pred_gpt2_1, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_pred_gpt2_1.rds")

lmer_pred_gpt2_2 <- lmer(predicted ~ ambiguity + height + (1+ambiguity+height||item) + (1|participant),
                         data=attach_pred_gpt2[attach_pred_gpt2$ROI==2,],
                         control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(lmer_pred_gpt2_2)
saveRDS(lmer_pred_gpt2_2, "/Users/mkugemoto/Documents/GitHub/sap_local/lmer_pred_gpt2_2.rds")


## ROI=0 ##
fixed_ambiguity <- fixef(lmer_pred_gpt2_0)[2]
fixed_height <- fixef(lmer_pred_gpt2_0)[3]
se_ambiguity <- coef(summary(lmer_pred_gpt2_0))[2, "Std. Error"]
se_height <- coef(summary(lmer_pred_gpt2_0))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_pred_gpt2_0)[['item']]$ambiguity
random_height <- ranef(lmer_pred_gpt2_0)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height 
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height 
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_gpt2_0 <- rbind(data.frame(
  item=rownames(ranef(lmer_pred_gpt2_0)[['item']]),
  ROI="0",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_pred_gpt2_0)[['item']]),
  ROI="0",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_gpt2_0 <- data.frame(
  ROI="0",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)

## ROI=1 ##
fixed_ambiguity <- fixef(lmer_pred_gpt2_1)[2]
fixed_height <- fixef(lmer_pred_gpt2_1)[3]
se_ambiguity <- coef(summary(lmer_pred_gpt2_1))[2, "Std. Error"]
se_height <- coef(summary(lmer_pred_gpt2_1))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_pred_gpt2_1)[['item']]$ambiguity
random_height <- ranef(lmer_pred_gpt2_1)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height 
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height 
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_gpt2_1 <- rbind(data.frame(
  item=rownames(ranef(lmer_pred_gpt2_1)[['item']]),
  ROI="1",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_pred_gpt2_1)[['item']]),
  ROI="1",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_gpt2_1 <- data.frame(
  ROI="1",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)

## ROI=2 ##
fixed_ambiguity <- fixef(lmer_pred_gpt2_2)[2]
fixed_height <- fixef(lmer_pred_gpt2_2)[3]
se_ambiguity <- coef(summary(lmer_pred_gpt2_2))[2, "Std. Error"]
se_height <- coef(summary(lmer_pred_gpt2_2))[3, "Std. Error"]
random_ambiguity <- ranef(lmer_pred_gpt2_2)[['item']]$ambiguity
random_height <- ranef(lmer_pred_gpt2_2)[['item']]$height
###compute itemwise effects
#these will be vectors of 24 numeric values
GPE_low = -fixed_ambiguity + (-1/2)*fixed_height -random_ambiguity + (-1/2)*random_height
GPE_high = -fixed_ambiguity + (1/2)*fixed_height -random_ambiguity + (1/2)*random_height
GPE_low_c = -fixed_ambiguity + (-1/2)*fixed_height 
GPE_high_c = -fixed_ambiguity + (1/2)*fixed_height 
low_upper = GPE_low_c + 2*(-se_ambiguity + (-1/2)*se_height)
low_lower = GPE_low_c - 2*(-se_ambiguity + (-1/2)*se_height)
high_upper = GPE_high_c + 2*(-se_ambiguity + (1/2)*se_height)
high_lower = GPE_high_c - 2*(-se_ambiguity + (1/2)*se_height)

by_item_lmer_gpt2_2 <- rbind(data.frame(
  item=rownames(ranef(lmer_pred_gpt2_2)[['item']]),
  ROI="2",
  coef="GPE_low",
  mean=GPE_low,
  upper=NA,
  lower=NA
), data.frame(
  item=rownames(ranef(lmer_pred_gpt2_2)[['item']]),
  ROI="2",
  coef="GPE_high",
  mean=GPE_high,
  upper=NA,
  lower=NA
))

by_construction_lmer_gpt2_2 <- data.frame(
  ROI="2",
  coef=c("GPE_low","GPE_high"),
  mean=c(GPE_low_c,GPE_high_c),
  upper=c(low_upper, high_upper),
  lower=c(low_lower, high_lower)
)


by_item_lmer_gpt2 <- rbind(by_item_lmer_gpt2_0, by_item_lmer_gpt2_1, by_item_lmer_gpt2_2)
saveRDS(by_item_lmer_gpt2, "/Users/mkugemoto/Documents/GitHub/sap_local/by_item_lmer_gpt2.rds")

by_construction_lmer_gpt2 <- rbind(by_construction_lmer_gpt2_0, by_construction_lmer_gpt2_1, by_construction_lmer_gpt2_2)
saveRDS(by_construction_lmer_gpt2, "/Users/mkugemoto/Documents/GitHub/sap_local/by_construction_lmer_gpt2.rds")
```


### correlation plot
```{r}
colnames(by_item_lmer)[which(names(by_item_lmer) == "mean")] <- "human"
colnames(by_item_lmer_gpt2)[which(names(by_item_lmer_gpt2) == "mean")] <- "gpt2"
colnames(by_item_lmer_lstm)[which(names(by_item_lmer_lstm) == "mean")] <- "lstm"

merged_by_item <- merge(merge(by_item_lmer, by_item_lmer_gpt2, by=c("item", "ROI", "coef")), 
                        by_item_lmer_lstm, by=c("item", "ROI", "coef"))

## plot the scatterplot for high at ROI=1, low at ROI=0
### gpt2
plot(merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='1', "human"], merged_by_item[merged_by_item$coef=="GPE_high" & merged_by_item$ROI=='1', "gpt2"], main="gpt2, high attachment")
plot(merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='0', "human"], merged_by_item[merged_by_item$coef=="GPE_low" & merged_by_item$ROI=='0', "gpt2"], main="gpt2, low attachment")

### lstm
plot(merged_by_item[merged_by_item$coef=="GPE_high"& merged_by_item$ROI=='1', "human"], merged_by_item[merged_by_item$coef=="GPE_high"& merged_by_item$ROI=='1', "lstm"], main="lstm, high attachment")
plot(merged_by_item[merged_by_item$coef=="GPE_low"& merged_by_item$ROI=='0', "human"], merged_by_item[merged_by_item$coef=="GPE_low"& merged_by_item$ROI=='0', "lstm"], main="lstm, low attachment")

## make a dataframe of the correlations
n = 1; lmer_correlation = data.frame()
for (ROI in c('0','1','2')){
  lmer_correlation[n,"type"] = "GPE_high"
  lmer_correlation[n,"ROI"] = ROI
  lmer_correlation[n,"model"] = "gpt2"
  lmer_correlation[n,"correlation"] = cor(merged_by_item[merged_by_item$coef=="GPE_high" &
                                                           merged_by_item$ROI==ROI, "human"],
                                          merged_by_item[merged_by_item$coef=="GPE_high" &
                                                           merged_by_item$ROI==ROI, "gpt2"])
  
  lmer_correlation[n+1,"type"] = "GPE_low"
  lmer_correlation[n+1,"ROI"] = ROI
    lmer_correlation[n+1,"model"] = "gpt2"
  lmer_correlation[n+1,"correlation"] = cor(merged_by_item[merged_by_item$coef=="GPE_low" &
                                                           merged_by_item$ROI==ROI, "human"],
                                          merged_by_item[merged_by_item$coef=="GPE_low" &
                                                           merged_by_item$ROI==ROI, "gpt2"])
  n = n+2
}

for (ROI in c('0','1','2')){
  lmer_correlation[n,"type"] = "GPE_high"
  lmer_correlation[n,"ROI"] = ROI
  lmer_correlation[n,"model"] = "lstm"
  lmer_correlation[n,"correlation"] = cor(merged_by_item[merged_by_item$coef=="GPE_high" &
                                                           merged_by_item$ROI==ROI, "human"],
                                          merged_by_item[merged_by_item$coef=="GPE_high" &
                                                           merged_by_item$ROI==ROI, "lstm"])
  
  lmer_correlation[n+1,"type"] = "GPE_low"
  lmer_correlation[n+1,"ROI"] = ROI
    lmer_correlation[n+1,"model"] = "lstm"
  lmer_correlation[n+1,"correlation"] = cor(merged_by_item[merged_by_item$coef=="GPE_low" &
                                                           merged_by_item$ROI==ROI, "human"],
                                          merged_by_item[merged_by_item$coef=="GPE_low" &
                                                           merged_by_item$ROI==ROI, "lstm"])
  n = n+2
}

ggplot(lmer_correlation, aes(x=ROI, y=correlation, colour=type, shape=type)) +
  geom_point() +
  facet_wrap(vars(model)) + 
  labs(x = 'ROI', y = 'correlation') 
```

### itemwise correlation (brms)
```{r}
itemwise_posterior <- function(model_path){
#  brm_model <- readRDS(model_path)     #for lstm & got2. because their brm fits are rds files
  brm_model <- model_path               #for empirical. because their brms fits are RData
  posterior_samp <- posterior_samples(brm_model)
  randomslope_names <-
    colnames(posterior_samp)[grepl('r_item.+(ambig|height)',colnames(posterior_samp))]
  posterior_samp <- posterior_samples(brm_model, fixed=TRUE, pars=
                                        c("b_ambiguity","b_height",randomslope_names))
  
  for (i in 1:24) {
    posterior_samp[paste0("high_item",as.character(i))] <-
      (-1)*(posterior_samp$b_ambiguity+posterior_samp[,i+2]) +
      (1/2)*(posterior_samp$b_height+posterior_samp[,i+26])
    posterior_samp[paste0("low_item",as.character(i))] <-
      (-1)*(posterior_samp$b_ambiguity+posterior_samp[,i+2]) -
      (1/2)*(posterior_samp$b_height+posterior_samp[,i+26])
  }
  return(posterior_samp)
}

posterior_emp_0  <- itemwise_posterior(brm_prior1_0)
posterior_emp_1  <- itemwise_posterior(brm_prior1_1)
posterior_emp_2  <- itemwise_posterior(brm_prior1_2)

posterior_lstm_0  <- itemwise_posterior("/Users/mkugemoto/Documents/GitHub/sap_local/brm_prior1_pred_lstm_0.rds")
posterior_lstm_1  <- itemwise_posterior("/Users/mkugemoto/Documents/GitHub/sap_local/brm_prior1_pred_lstm_1.rds")
posterior_lstm_2  <- itemwise_posterior("/Users/mkugemoto/Documents/GitHub/sap_local/brm_prior1_pred_lstm_2.rds")

posterior_gpt2_0  <- itemwise_posterior("/Users/mkugemoto/Documents/GitHub/sap_local/brm_prior1_pred_gpt2_0.rds")
posterior_gpt2_1  <- itemwise_posterior("/Users/mkugemoto/Documents/GitHub/sap_local/brm_prior1_pred_gpt2_1.rds")
posterior_gpt2_2  <- itemwise_posterior("/Users/mkugemoto/Documents/GitHub/sap_local/brm_prior1_pred_gpt2_2.rds")

# sample 1000 times
correlation1000 <- function(emp, lstm, gpt2){
  correlations <- data.frame()
  samp_num_emp <- sample(1:12000, 1000, replace=F)
  samp_num_lstm <- sample(1:24000, 1000, replace=F)
  samp_num_gpt2 <- sample(1:24000, 1000, replace=F)
  for (n in 1:1000) {
    correlations[n,"high_lstm"] <-
      cor(unlist(emp[samp_num_emp[n],colnames(emp)[grepl('high_item',colnames(emp))]], use.names = F),
          unlist(lstm[samp_num_lstm[n],colnames(lstm)[grepl('high_item',colnames(lstm))]], use.names = F))
    correlations[n,"low_lstm"] <-
      cor(unlist(emp[samp_num_emp[n],colnames(emp)[grepl('low_item',colnames(emp))]], use.names = F),
          unlist(lstm[samp_num_lstm[n],colnames(lstm)[grepl('low_item',colnames(lstm))]], use.names = F))
    correlations[n,"high_gpt2"] <-
      cor(unlist(emp[samp_num_emp[n],colnames(emp)[grepl('high_item',colnames(emp))]], use.names = F),
          unlist(gpt2[samp_num_gpt2[n],colnames(gpt2)[grepl('high_item',colnames(gpt2))]], use.names = F))
    correlations[n,"low_gpt2"] <-
      cor(unlist(emp[samp_num_emp[n],colnames(emp)[grepl('low_item',colnames(emp))]], use.names = F),
          unlist(gpt2[samp_num_gpt2[n],colnames(gpt2)[grepl('low_item',colnames(gpt2))]], use.names = F))
  }
  return(correlations)
}

cor_0 <- correlation1000(posterior_emp_0, posterior_lstm_0, posterior_gpt2_0)
cor_1 <- correlation1000(posterior_emp_1, posterior_lstm_1, posterior_gpt2_1)
cor_2 <- correlation1000(posterior_emp_2, posterior_lstm_2, posterior_gpt2_2)

# plot
correlation_table <- data.frame(
  "correlation" = c(mean(cor_0$high_lstm),mean(cor_0$low_lstm),mean(cor_0$high_gpt2),mean(cor_0$low_gpt2),
                    mean(cor_1$high_lstm),mean(cor_1$low_lstm),mean(cor_1$high_gpt2),mean(cor_1$low_gpt2),
                    mean(cor_2$high_lstm),mean(cor_2$low_lstm),mean(cor_2$high_gpt2),mean(cor_2$low_gpt2)),
  "sd" = c(sd(cor_0$high_lstm),sd(cor_0$low_lstm),sd(cor_0$high_gpt2),sd(cor_0$low_gpt2),
           sd(cor_1$high_lstm),sd(cor_1$low_lstm),sd(cor_1$high_gpt2),sd(cor_1$low_gpt2),
           sd(cor_2$high_lstm),sd(cor_2$low_lstm),sd(cor_2$high_gpt2),sd(cor_2$low_gpt2)),
  "type" = rep(c("high_attachment","low_attachment"),6),
  "model" = rep(c("lstm","lstm","gpt2","gpt2"),6),
  "ROI" = c(rep("0",4), rep("1",4), rep("2",4))
)

ggplot(correlation_table, aes(x=ROI, y=correlation, colour=type, shape=type)) +
  geom_point() +
  geom_errorbar(aes(ymin=correlation - (1.96*sd), 
                    ymax = correlation + (1.96*sd)),
                width=.5,position=position_dodge(0.02)) + 
  facet_wrap(vars(model)) + 
  labs(x = 'ROI', y = 'correlation')
```








